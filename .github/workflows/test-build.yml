name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    # CI runs on GitHub's cloud

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Lint
        run: |
          go install github.com/mgechev/revive@latest
          revive -set_exit_status ./...

      - name: Test
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Build Agent Binary
        run: go build -o agent-binary ./agent/main.go

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: agent-binary
          path: agent-binary

  deploy:
    needs: build
    runs-on: [self-hosted, Linux]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    # CD only runs on push to main, not on PRs

    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: agent-binary
          path: ./opt/voice-agent/

      - name: Make binary executable
        run: chmod +x ./opt/voice-agent/agent-binary

      - name: Restart voice agent service
        run: systemctl --user restart voice-agent

      - name: Check service status
        run: systemctl --user status voice-agent --no-pager

      - name: Smoke test - verify Pi connectivity
        run: ping -c 3 pi-server
